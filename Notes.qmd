---
title: "Causal Inference for Time-varying Treatments"
format:
  html:
    theme: cosmo
    embed-resources: true
    number-sections: false
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: false
knitr:
  opts_chunk: 
    cache: false    
    echo: true
    fig.align: 'center'
    fig.width: 6
    fig.height: 4
    message: FALSE
---

## Time-varying Treatments

### The causal effect of time-varying treatments

Consider a time-fixed treatment variable $A$ (1: treated, 0: untreated) at time zero of follow-up and an outcome variable $Y$. The average causal effect of $A$ on the outcome $Y$ as the contrast between the mean counterfactual outcome $Y^{a=1}$ under treatment and the mean counterfactual outcome $Y^{a=0}$ under no treatment, that is,

$$
E[Y^{a=1}] - E[Y^{a=0}]
$$

Because treatment status is determined at a **single time** (time zero) for everybody, the average causal effect does not need to make reference to the time at which treatment occurs. In contrast, causal contrasts that involve time-varying treatments need to incorporate time explicitly.

Consider a time-varying dichotomous treatment $A_k$ that may change at every month $k$ of follow-up, where $k = 0, 1, 2, \dots, K$. $A_k$ takes value 1 if the individual receives treatment in month $k$, and 0 otherwise. No individuals received treatment before the start of the study at time 0, i.e., $A_{−1} = 0$ for all individuals. The history of treatment from time 0 to time k is denoted by

$$
\bar{A}_k = (A_0, A_1, \dots, A_k)
$$

An individual who receives treatment continuously throughout the follow-up has treatment history $\bar{A} = (1, 1, \dots, 1) = \bar{1}$. Analogously, an individual who never receives treatment during the follow-up has treatment history $\bar{A} = (0, 0, \dots, 0) = \bar{0}$.

Suppose $Y$ measures health status -- with higher values of $Y$ indicating better health -- at the end of follow-up at time $K + 1$. We would like to estimate the average causal effect of the time-varying treatment $\bar A$ on the outcome $Y$. Therefore, we will have to define the average causal effect as a contrast between the counterfactual mean outcomes under two treatment strategies that involve treatment at **all times** between the start ($k = 0$) and the end ($k = K$) of the follow-up.

### Treatment strategies

A treatment strategy -- also referred to as a plan, policy, protocol, or regime -- is a rule to assign treatment at each time k of follow-up.

$$
\begin{aligned}
&\text{Strategy 1 - Always Treat:} & \quad \bar{a} = (1, 1, \dots, 1) = \bar{1} \\
&\text{Strategy 2 - Never Treat:} & \quad \bar{a} = (0, 0, \dots, 0) = \bar{0}
\end{aligned}
$$

We can define an average causal effect of $\bar A$ on the outcome $Y$ as the contrast between the mean counterfactual outcome $Y^{\bar a = \bar 1}$ under the strategy “always treat” and the mean counterfactual outcome $Y^{\bar a = \bar 0}$ under the strategy “never treat”, that is,

$$
E[Y^{\bar a = \bar 1}] - E[Y^{\bar a = \bar 0}]
$$

The number of possible contrasts is very large: we can define at least $2^K$ treatment strategies. In fact, these $2^K$ such strategies **do not exhaust all possible treatment strategies**.

::: callout-note
-   Deterministic dynamic treatment strategy

    $$
    g = [g_0(\bar a_{-1}, l_0), \dots, g_K(\bar a_{K-1}, \bar l_K)]
    $$
    
    where $g_k(\bar a_{K-1}, \bar l_k)$ specifies the treatment assigned at $k$ to an individual with past history $(\bar a_{K-1}, \bar l_k)$.
    
-   Deterministic static treatment strategy

    $$
    g = [g_0(\bar a_{-1}), \dots, g_K(\bar a_{K-1})]
    $$
    
    where $g_k(\bar a_{K-1})$ does not depend on $\bar l_k$
    
-   Random treatment strategies

    Random treatment strategies that do not assign a particular value of treatment, but rather a probability of receiving a treatment value. Random treatment strategies can be static or dynamic.
    
We refer to the strategy $g$ for which the mean counterfactual outcome $E [Y^g]$ is maximized (when higher values of outcome are better) as the **optimal treatment strategy**. Optimal strategy will almost always be dynamic. However, random strategies (i.e., randomized trials) remain scientifically necessary because, before the trial, it is unknown which deterministic strategy is optimal.
:::

### Sequentially randomized experiments

-   Notations in causal diagrams

    -   $A_k$: time-varying treatment
    -   $L_k$: set of measured variables
    -   $Y$: outcome
    -   $U_k$: set of unmeasured variables that are common causes of at least two other variables on the causal graph
    

**Causal graph 1**

::: {style="text-align: center;"}
![](./fig/fig19_1.png){width=50%}
:::

The causal diagram in Figure 19.1 lacks arrows from either the measured covariates $\bar L_k$ or the unmeasured covariates $\bar U_k$ into treatment $A_k$. It could represent a randomized experiment in which treatment $A_k$ at each time $k$ is randomly assigned with a probability that depends **only on prior treatment history**.

When interested in the contrast of static treatment strategies, Figure 19.1 is the proper generalization of no confounding by measured or unmeasured variables for time-varying treatments.

**Causal graph 2**

::: {style="text-align: center;"}

![](./fig/fig19_2.png){width=50%}

:::

The causal diagram in Figure 19.2 includes arrows from measured covariates $\bar L_k$, but not from the unmeasured covariates $\bar U_k$, into treatment $A_k$. It could represent a randomized experiment in which treatment $A_k$ at each time $k$ is randomly assigned by the investigators with a probability that depends on **prior treatment and measured covariate history**.

An experiment in which treatment is randomly assigned at each time $k$ to each individual is referred to as a sequentially randomized experiment. Therefore Figures 19.1 and 19.2 could represent sequentially randomized experiments.

**Causal graph 3**

::: {style="text-align: center;"}
![](./fig/fig19_3.png){width=50%}
:::

The causal diagram in Figure 19.3 includes arrows from both measured covariates $\bar L_k$ and unmeasured covariates $\bar U_k$ into treatment $A_k$. In contrast to Figures 19.1 and 19.2, Figure 19.3 cannot represent a randomized experiment: the value of treatment $A_k$ at each time $k$ depends partly on unmeasured variables $U$ which are causes of $L_k$ and $Y$ , but unmeasured variables obviously cannot be used by investigators to assign treatment.

In observational studies, decisions about treatment often depend on outcome predictors such as prognostic factors. Therefore, observational studies will be typically represented by either Figure 19.2 or Figure 19.3 rather than Figure 19.1. An observational study represented by Figure 19.2 would differ from a sequentially randomized experiment only in that **the assignment probabilities are unknown** (but could be estimated from the data).

Unfortunately, it is impossible to show empirically whether an observational study is represented by the causal diagram in either Figure 19.2 or Figure 19.3.

### Sequential exchangeability







